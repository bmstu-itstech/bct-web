<!-- tournament/templates/tournament/leaderboard.html -->
{% extends "base_full.html" %}

{% block main %}
    <main>
        <div class="leaderboard">
            <h2 class="leaderboard__title">{{ game }}</h2>
            <form method="post" action="{% url 'upload' %}" class="upload__form" id="upload-program-form" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="upload__file-button">
                    <label class="upload__label" for="file-upload">Загрузить .py</label>
                    <input class="upload__file-input" type="file" id="file-upload" name="file" accept=".py" onchange="handleFileUpload()"/>
                </div>
                <div class="upload__preview">
                    <a href="{{ program_url }}" class="upload__preview-link">{{ program_name }}</a>
                </div>
            </form>
            <table class="leaderboard__table" id="leaderboard">
                <thead>
                <tr>
                    <th></th>
                    <th>Команда</th>
                    <th>Очки</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td>1</td>
                    <td>Организаторы</td>
                    <td>25</td>
                </tr>
                <tr>
                    <td>2</td>
                    <td>Организаторы 2</td>
                    <td>23</td>
                </tr>
                <tr>
                    <td>3</td>
                    <td>Организаторы</td>
                    <td>25</td>
                </tr>
                <tr>
                    <td>4</td>
                    <td>Организаторы 2</td>
                    <td>23</td>
                </tr>
                </tbody>
            </table>
        </div>
    </main>
{% endblock %}

{% block script %}
    <script>
        const ws = new WebSocket('ws://' + window.location.host + '/ws/leaderboard/');

        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            const tbody = document.querySelector('#leaderboard tbody');

            tbody.classList.add('fade-effect');

            tbody.innerHTML = '';

            for (const [place, team] of data.entries()) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${place + 1}</td>
                    <td>${team.name}</td>
                    <td>${team.score}</td>
                `;
                tbody.appendChild(row);
            }

            setTimeout(() => {
                tbody.classList.remove('fade-effect');
            }, 1000); // 1s
        };

        function handleFileUpload() {
            document.getElementById('upload-program-form').submit();
        }
    </script>
{% endblock %}

